{% extends 'base.html' %}
{% block title %}–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞{% endblock %}
{% block content %}
<form method="post" class="section">
  {% csrf_token %}
  <div class="row">
    <div>
      <h3>–ü–∞–ø–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç</h3>
      <label>{{ form.job_name.label }}</label>
      {{ form.job_name }}
      <p class="muted" style="font-size: 12px; color: #666;">{{ form.job_name.help_text }}</p>
      
      <label>{{ form.use_yadisk }} {{ form.use_yadisk.label }}</label>
      <p class="muted" style="font-size: 12px; color: #666;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤—ã–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ</p>
      
      <div id="local-paths" style="display: none;">
        <label>{{ form.input_folder.label }}</label>
        {{ form.input_folder }}
        <label>{{ form.output_folder.label }}</label>
        {{ form.output_folder }}
      </div>
      
      <div id="yadisk-paths" style="display: none;">
        <label>{{ form.input_yadisk_path.label }}</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          {{ form.input_yadisk_path }}
          <button type="button" id="browse-input-yadisk" style="padding: 5px 10px;">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button>
        </div>
        <label>{{ form.output_yadisk_path.label }}</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          {{ form.output_yadisk_path }}
          <button type="button" id="browse-output-yadisk" style="padding: 5px 10px;">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button>
        </div>
      </div>
      
      <label>{{ form.fmt.label }}</label>
      {{ form.fmt }}
      <label>{{ form.copies.label }}</label>
      {{ form.copies }}
    </div>
    <div>
      <h3>–¢–µ–∫—Å—Ç</h3>
      <label>{{ form.text_enabled }} {{ form.text_enabled.label }}</label>
      <label>{{ form.text_content.label }}</label>
      {{ form.text_content }}
      
      <label>{{ form.text_font_from_yadisk }} {{ form.text_font_from_yadisk.label }}</label>
      <div id="text-font-local" style="display: block;">
        <label>{{ form.text_fontfile.label }}</label>
        {{ form.text_fontfile }}
      </div>
      <div id="text-font-yadisk" style="display: none;">
        <label>{{ form.text_fontfile_yadisk.label }}</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          {{ form.text_fontfile_yadisk }}
          <button type="button" id="browse-font-yadisk" style="padding: 5px 10px;">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        </div>
      </div>
      
      <label>{{ form.text_auto }} {{ form.text_auto.label }}</label>
      <label>{{ form.text_level.label }}</label>
      {{ form.text_level }}
      <label>{{ form.text_fontsize.label }}</label>
      {{ form.text_fontsize }}
      <label>{{ form.text_position.label }}</label>
      {{ form.text_position }}
    </div>
  </div>

  <div class="row">
    <div>
      <h3>–ë–µ–π–¥–∂</h3>
      <label>{{ form.badge_enabled }} {{ form.badge_enabled.label }}</label>
      
      <label>{{ form.badge_from_yadisk }} {{ form.badge_from_yadisk.label }}</label>
      <div id="badge-local" style="display: block;">
        <label>{{ form.badge_path.label }}</label>
        {{ form.badge_path }}
      </div>
      <div id="badge-yadisk" style="display: none;">
        <label>{{ form.badge_path_yadisk.label }}</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          {{ form.badge_path_yadisk }}
          <button type="button" id="browse-badge-yadisk" style="padding: 5px 10px;">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        </div>
      </div>
      
      <label>{{ form.badge_random_scale }} {{ form.badge_random_scale.label }}</label>
      <label>{{ form.badge_scale_percent.label }}</label>
      {{ form.badge_scale_percent }}
      <label>{{ form.badge_position.label }}</label>
      {{ form.badge_position }}
      <label>{{ form.badge_behavior.label }}</label>
      {{ form.badge_behavior }}
    </div>
    <div>
      <h3>–û–ø—Ü–∏–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
      <label>{{ form.safe_mode }} {{ form.safe_mode.label }}</label>
      <label>{{ form.profile_strong }} {{ form.profile_strong.label }}</label>
      <label>{{ form.cut }} {{ form.cut.label }}</label>
      <label>{{ form.contrast }} {{ form.contrast.label }}</label>
      <label>{{ form.color_shift }} {{ form.color_shift.label }}</label>
      <label>{{ form.noise }} {{ form.noise.label }}</label>
      <label>{{ form.brightness_sat }} {{ form.brightness_sat.label }}</label>
      <label>{{ form.crop_edges }} {{ form.crop_edges.label }}</label>
      <label>{{ form.geom }} {{ form.geom.label }}</label>
      <label>{{ form.time_mod }} {{ form.time_mod.label }}</label>
      <label>{{ form.overlays }} {{ form.overlays.label }}</label>
      <label>{{ form.codec_random }} {{ form.codec_random.label }}</label>
      <label>{{ form.color_mod }} {{ form.color_mod.label }}</label>
      <label>{{ form.hidden_pattern }} {{ form.hidden_pattern.label }}</label>
      <label>{{ form.fixed_duration_enabled }} {{ form.fixed_duration_enabled.label }}</label>
      <label>{{ form.fixed_duration.label }}</label>
      {{ form.fixed_duration }}
    </div>
  </div>

  <div style="margin-top: 20px; margin-bottom: 20px;">
    <button type="button" id="mass-process-btn" name="action" value="batch">–°–æ–∑–¥–∞—Ç—å –ø–∞–∫–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É</button>
    <span style="color: #b31b1b; font-weight: bold; font-size: 15px; letter-spacing:1px; margin-left:28px; display:block; margin-bottom:1px;">–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!</span>
    <button type="submit" name="action" value="test" style="margin-left: 10px;">–¢–µ—Å—Ç –æ–¥–Ω–æ–≥–æ –≤–∏–¥–µ–æ</button>
  </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="massConfirmModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(33,33,33,0.58);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:28px 32px 22px 32px;box-shadow:0 6px 28px #333;width:420px;max-width:97vw;border-radius:10px;text-align:center;">
    <div style="font-size:18px;margin-bottom:17px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å <span id="video-count-placeholder"></span> –≤–∏–¥–µ–æ?<br>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–º —Ä–æ–ª–∏–∫–µ –≤—ã–¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
    <button type="button" id="confirm-mass-yes" style="background:#2a5;font-size:15px;padding:7px 18px;margin-right:10px;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    <button type="button" id="confirm-mass-no" style="background:#fa5;font-size:15px;padding:7px 18px;">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞ (–¥–ª—è –ø–∞–ø–æ–∫) -->
<div id="yadiskBrowserModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(33,33,33,0.58);z-index:1001;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:28px 32px 22px 32px;box-shadow:0 6px 28px #333;width:600px;max-width:97vw;max-height:80vh;border-radius:10px;">
    <h3 style="margin-top:0;" id="yadisk-browser-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ</h3>
    <div id="yadisk-current-path" style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:5px;">
      <strong>–¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞:</strong> <span id="yadisk-path-display">/</span>
    </div>
    <div id="yadisk-folder-list" style="max-height:400px;overflow-y:auto;border:1px solid #ddd;border-radius:5px;padding:10px;">
      <div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" id="yadisk-select-item" style="background:#2a5;font-size:15px;padding:7px 18px;">–í—ã–±—Ä–∞—Ç—å</button>
      <button type="button" id="yadisk-browser-cancel" style="background:#fa5;font-size:15px;padding:7px 18px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
  (function() {
    var useYadiskCheckbox = document.querySelector('[name="use_yadisk"]');
    var localPathsDiv = document.getElementById('local-paths');
    var yadiskPathsDiv = document.getElementById('yadisk-paths');
    var yadiskConnected = false;
    var currentBrowserTarget = null; // 'input', 'output', 'font', 'badge'
    var currentBrowserPath = '/';
    var currentBrowserMode = 'folder'; // 'folder' or 'file'
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∏ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫ –ø—É—Ç—è–º–∏
    function togglePaths() {
      if (useYadiskCheckbox.checked) {
        localPathsDiv.style.display = 'none';
        yadiskPathsDiv.style.display = 'block';
        checkYadiskConnection();
      } else {
        localPathsDiv.style.display = 'block';
        yadiskPathsDiv.style.display = 'none';
      }
    }
    
    useYadiskCheckbox.addEventListener('change', togglePaths);
    togglePaths(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —à—Ä–∏—Ñ—Ç–∞
    var textFontFromYadisk = document.querySelector('[name="text_font_from_yadisk"]');
    var textFontLocalDiv = document.getElementById('text-font-local');
    var textFontYadiskDiv = document.getElementById('text-font-yadisk');
    
    function toggleTextFont() {
      if (textFontFromYadisk && textFontFromYadisk.checked) {
        textFontLocalDiv.style.display = 'none';
        textFontYadiskDiv.style.display = 'block';
      } else {
        textFontLocalDiv.style.display = 'block';
        textFontYadiskDiv.style.display = 'none';
      }
    }
    
    if (textFontFromYadisk) {
      textFontFromYadisk.addEventListener('change', toggleTextFont);
      toggleTextFont();
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –±–µ–π–¥–∂–∞
    var badgeFromYadisk = document.querySelector('[name="badge_from_yadisk"]');
    var badgeLocalDiv = document.getElementById('badge-local');
    var badgeYadiskDiv = document.getElementById('badge-yadisk');
    
    function toggleBadge() {
      if (badgeFromYadisk && badgeFromYadisk.checked) {
        badgeLocalDiv.style.display = 'none';
        badgeYadiskDiv.style.display = 'block';
      } else {
        badgeLocalDiv.style.display = 'block';
        badgeYadiskDiv.style.display = 'none';
      }
    }
    
    if (badgeFromYadisk) {
      badgeFromYadisk.addEventListener('change', toggleBadge);
      toggleBadge();
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫—É
    function checkYadiskConnection() {
      fetch('/api/yadisk/check', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
      })
        .then(function(response) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type
          var contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(function(text) {
              throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON. –í–æ–∑–º–æ–∂–Ω–æ, URL –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –û—Ç–≤–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: ' + text.substring(0, 100));
            });
          }
          return response.json();
        })
        .then(function(j) {
          yadiskConnected = j.connected;
          if (!yadiskConnected) {
            var errorMsg = j.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫—É:\n' + errorMsg + 
                  '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n' +
                  '1. –¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è YANDEX_DISK_TOKEN –∏–ª–∏ –≤ —Ñ–∞–π–ª–µ .env\n' +
                  '2. –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏ –Ω–µ –∏—Å—Ç–µ–∫\n' +
                  '3. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞\n' +
                  '4. –§–∞–π–ª .env –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞');
          }
        })
        .catch(function(err) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫—É:\n' + err.message +
                '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n' +
                '1. –°–µ—Ä–≤–µ—Ä Django –∑–∞–ø—É—â–µ–Ω\n' +
                '2. URL –¥–æ—Å—Ç—É–ø–µ–Ω: http://localhost:8000/api/yadisk/check\n' +
                '3. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π');
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞:', err);
        });
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–∞–ø–æ–∫/—Ñ–∞–π–ª–æ–≤ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞
    function openYadiskBrowser(target, mode) {
      currentBrowserTarget = target;
      currentBrowserMode = mode || 'folder';
      currentBrowserPath = '/';
      var title = document.getElementById('yadisk-browser-title');
      if (mode === 'file') {
        title.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ';
      } else {
        title.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ';
      }
      document.getElementById('yadiskBrowserModal').style.display = 'flex';
      loadYadiskList('/');
    }
    
    document.getElementById('browse-input-yadisk').onclick = function() {
      openYadiskBrowser('input', 'folder');
    };
    
    document.getElementById('browse-output-yadisk').onclick = function() {
      openYadiskBrowser('output', 'folder');
    };
    
    document.getElementById('browse-font-yadisk').onclick = function() {
      openYadiskBrowser('font', 'file');
    };
    
    document.getElementById('browse-badge-yadisk').onclick = function() {
      openYadiskBrowser('badge', 'file');
    };
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–∞–ø–æ–∫/—Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ
    function loadYadiskList(path) {
      var listDiv = document.getElementById('yadisk-folder-list');
      var pathDisplay = document.getElementById('yadisk-path-display');
      listDiv.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      pathDisplay.textContent = path;
      currentBrowserPath = path;
      
      var url = '/api/yadisk/list?path=' + encodeURIComponent(path);
      if (currentBrowserMode === 'file') {
        url += '&type=all'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –ø–∞–ø–∫–∏ –∏ —Ñ–∞–π–ª—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
      } else {
        url += '&type=dirs'; // –¢–æ–ª—å–∫–æ –ø–∞–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–∞–ø–æ–∫
      }
      
      fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(j) {
          if (j.error) {
            listDiv.innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + j.error + '</div>';
            return;
          }
          
          var items = j.items || [];
          var html = '<div style="margin-bottom:10px;">';
          
          // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –µ—Å–ª–∏ –Ω–µ –≤ –∫–æ—Ä–Ω–µ
          if (path !== '/') {
            var parentPath = path.split('/').slice(0, -1).join('/') || '/';
            html += '<div style="padding:8px;cursor:pointer;background:#e8e8e8;margin-bottom:5px;border-radius:3px;" onclick="loadYadiskList(\'' + parentPath + '\')">üìÅ .. (–Ω–∞–≤–µ—Ä—Ö)</div>';
          }
          
          // –†–∞–∑–¥–µ–ª—è–µ–º –ø–∞–ø–∫–∏ –∏ —Ñ–∞–π–ª—ã
          var folders = items.filter(function(item) { return item.type === 'dir'; });
          var files = items.filter(function(item) { return item.type === 'file'; });
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–ø–∫–∏
          folders.forEach(function(item) {
            html += '<div style="padding:8px;cursor:pointer;background:#f5f5f5;margin-bottom:5px;border-radius:3px;border:1px solid #ddd;" onclick="loadYadiskList(\'' + item.path + '\')">üìÅ ' + item.name + '</div>';
          });
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤)
          if (currentBrowserMode === 'file') {
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–ª–∏
            var allowedExtensions = [];
            if (currentBrowserTarget === 'font') {
              allowedExtensions = ['.ttf', '.otf', '.woff', '.woff2', '.eot'];
            } else if (currentBrowserTarget === 'badge') {
              allowedExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.mp4', '.mov'];
            }
            
            var filteredFiles = files;
            if (allowedExtensions.length > 0) {
              filteredFiles = files.filter(function(item) {
                var ext = item.name.substring(item.name.lastIndexOf('.')).toLowerCase();
                return allowedExtensions.indexOf(ext) !== -1;
              });
            }
            
            if (filteredFiles.length === 0 && files.length > 0) {
              html += '<div style="padding:8px;background:#fff3cd;margin-bottom:5px;border-radius:3px;border:1px solid #ffc107;">‚ÑπÔ∏è –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–¥—Ö–æ–¥—è—â–∏–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º. –ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Ñ–∞–π–ª—ã.</div>';
              filteredFiles = files;
            }
            
            filteredFiles.forEach(function(item) {
              var icon = 'üìÑ';
              var ext = item.name.substring(item.name.lastIndexOf('.')).toLowerCase();
              if (['.png', '.jpg', '.jpeg', '.gif', '.webp'].indexOf(ext) !== -1) {
                icon = 'üñºÔ∏è';
              } else if (['.mp4', '.mov', '.avi'].indexOf(ext) !== -1) {
                icon = 'üé¨';
              } else if (['.ttf', '.otf', '.woff'].indexOf(ext) !== -1) {
                icon = 'üî§';
              }
              html += '<div style="padding:8px;cursor:pointer;background:#e7f3ff;margin-bottom:5px;border-radius:3px;border:1px solid #0066cc;" onclick="selectYadiskFile(\'' + item.path + '\')">' + icon + ' ' + item.name + '</div>';
            });
          }
          
          if (folders.length === 0 && (currentBrowserMode === 'folder' || (currentBrowserMode === 'file' && files.length === 0))) {
            html += '<div style="text-align:center;padding:20px;color:#999;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
          }
          
          html += '</div>';
          listDiv.innerHTML = html;
        })
        .catch(function() {
          listDiv.innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</div>';
        });
    }
    
    // –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    function selectYadiskFile(filePath) {
      currentBrowserPath = filePath;
      document.getElementById('yadisk-select-item').click();
    }
    
    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ onclick
    window.loadYadiskList = loadYadiskList;
    window.selectYadiskFile = selectYadiskFile;
    
    // –í—ã–±–æ—Ä –ø–∞–ø–∫–∏ –∏–ª–∏ —Ñ–∞–π–ª–∞
    document.getElementById('yadisk-select-item').onclick = function() {
      var targetInput;
      if (currentBrowserTarget === 'input') {
        targetInput = document.querySelector('[name="input_yadisk_path"]');
      } else if (currentBrowserTarget === 'output') {
        targetInput = document.querySelector('[name="output_yadisk_path"]');
      } else if (currentBrowserTarget === 'font') {
        targetInput = document.querySelector('[name="text_fontfile_yadisk"]');
      } else if (currentBrowserTarget === 'badge') {
        targetInput = document.querySelector('[name="badge_path_yadisk"]');
      }
      
      if (targetInput) {
        targetInput.value = currentBrowserPath;
      }
      document.getElementById('yadiskBrowserModal').style.display = 'none';
    };
    
    document.getElementById('yadisk-browser-cancel').onclick = function() {
      document.getElementById('yadiskBrowserModal').style.display = 'none';
    };
    
    // –ü–æ–¥—Å—á–µ—Ç –≤–∏–¥–µ–æ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    document.getElementById('mass-process-btn').onclick = function(e) {
      e.preventDefault();
      var useYadisk = useYadiskCheckbox.checked;
      var folder, placeholder = document.getElementById('video-count-placeholder');
      placeholder.innerText = '‚Ä¶';
      document.getElementById('massConfirmModal').style.display = 'flex';
      
      if (useYadisk) {
        folder = document.querySelector('[name="input_yadisk_path"]').value;
        if (!folder) { placeholder.innerText = '0'; return; }
        fetch('/api/yadisk/count_videos?path=' + encodeURIComponent(folder))
          .then(function(r){ return r.json(); })
          .then(function(j){ placeholder.innerText = (j && typeof j.count === 'number') ? j.count : '?'; })
          .catch(function(){ placeholder.innerText = '?'; });
      } else {
        folder = document.querySelector('[name="input_folder"]').value;
        if (!folder) { placeholder.innerText = '0'; return; }
        fetch('/api/count_videos?input=' + encodeURIComponent(folder))
          .then(function(r){ return r.json(); })
          .then(function(j){ placeholder.innerText = (j && typeof j.count === 'number') ? j.count : '?'; })
          .catch(function(){ placeholder.innerText = '?'; });
      }
    };
    
    document.getElementById('confirm-mass-yes').onclick = function() {
      var frm = document.querySelector('form.section');
      var fakeBtn = document.createElement('button');
      fakeBtn.type = 'submit';
      fakeBtn.name = 'action';
      fakeBtn.value = 'batch';
      fakeBtn.style.display = 'none';
      frm.appendChild(fakeBtn);
      document.getElementById('massConfirmModal').style.display = 'none';
      fakeBtn.click();
    };
    
    document.getElementById('confirm-mass-no').onclick = function() {
      document.getElementById('massConfirmModal').style.display = 'none';
    };
  })();
</script>
</form>

<div class="section">
  <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏</h3>
  <table>
    <thead><tr><th>ID</th><th>–ò–º—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–ò—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</th><th>–ì–æ—Ç–æ–≤–æ —Ñ–∞–π–ª–æ–≤</th><th>–°–æ–∑–¥–∞–Ω–∞</th><th></th></tr></thead>
    <tbody>
      {% for j in jobs %}
      <tr>
        <td>{{ j.id }}</td>
        <td>{{ j.name }}</td>
        <td>{{ j.status }}</td>
        <td>{{ j.progress_overall }}% ({{ j.done_tasks }}/{{ j.total_tasks }})</td>
        <td>{{ j.src_files_total|default:"-" }}</td>
        <td>{{ j.done_tasks|default:"-" }}</td>
        <td>{{ j.created_at }}</td>
        <td><a href="{% url 'job_detail' j.id %}">–û—Ç–∫—Ä—ã—Ç—å</a></td>
      </tr>
      {% empty %}
      <tr><td colspan="8">–ù–µ—Ç –∑–∞–¥–∞—á</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <p><a href="/">–û–±–Ω–æ–≤–∏—Ç—å</a></p>
  </div>
{% endblock %}
